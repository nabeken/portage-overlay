From a447ced5d5215250968fea48c4125b60eeac040f Mon Sep 17 00:00:00 2001
From: TANABE Ken-ichi <nabeken@tknetworks.org>
Date: Mon, 8 Jun 2009 22:44:12 +0900
Subject: [PATCH] service/gentoo: Managing /etc/runlevels directly for enabling and disabling

---
 lib/puppet/provider/service/gentoo.rb |   66 +++++++++++++++++++-------------
 1 files changed, 39 insertions(+), 27 deletions(-)

diff --git a/lib/puppet/provider/service/gentoo.rb b/lib/puppet/provider/service/gentoo.rb
index d62df1a..f9df199 100644
--- a/lib/puppet/provider/service/gentoo.rb
+++ b/lib/puppet/provider/service/gentoo.rb
@@ -3,54 +3,66 @@
 Puppet::Type.type(:service).provide :gentoo, :parent => :init do
     desc "Gentoo's form of ``init``-style service management.
 
-    Uses ``rc-update`` for service enabling and disabling.
+    Managing /etc/runlevels/default directly for enabling and disabling.
 
-  "
-
-    commands :update => "/sbin/rc-update"
+    "
 
     confine :operatingsystem => :gentoo
 
     defaultfor :operatingsystem => :gentoo
 
+    @@levels = []
+
+    begin
+	Dir.open("/etc/runlevels").each do |entry|
+	    @@levels.push entry if File.directory?("/etc/runlevels/#{entry}") and entry =~ /^[^.]/
+	end
+    rescue
+	raise Puppet::Error, "Could not get service names"
+    end
+
     def self.defpath
         superclass.defpath
     end
 
     def disable
-        begin
-            output = update :del, @resource[:name], :default
-        rescue Puppet::ExecutionFailure
-            raise Puppet::Error, "Could not disable %s: %s" %
-                [self.name, output]
+        @@levels.each do |l|
+            service = "/etc/runlevels/#{l}/#{@resource[:name]}"
+
+            if File.exist?(service)
+                begin
+                    File.delete(service)
+                rescue
+                    raise Puppet::Error, "Could not disable %s" % self.name
+                end
+            end
         end
     end
 
     def enabled?
-        begin
-            output = update :show
-        rescue Puppet::ExecutionFailure
-            return :false
-        end
-
-        line = output.split(/\n/).find { |l| l.include?(@resource[:name]) }
+	result = :false
 
-        return :false unless line
+        @@levels.each do |l|
+            service = "/etc/runlevels/#{l}/#{@resource[:name]}"
 
-        # If it's enabled then it will print output showing service | runlevel
-        if output =~ /#{@resource[:name]}\s*\|\s*(boot|default)/
-            return :true
-        else
-            return :false
+            if File.exist?(service)
+                result = :true
+            end
         end
+
+	return result
     end
 
     def enable
-        begin
-            output = update :add, @resource[:name], :default
-        rescue Puppet::ExecutionFailure
-            raise Puppet::Error, "Could not enable %s: %s" %
-                [self.name, output]
+    	service = "/etc/runlevels/default/#{@resource[:name]}"
+
+        unless File.exist?(service)
+            begin
+                File.symlink("/etc/init.d/#{@resource[:name]}", service)
+            rescue
+                raise Puppet::Error, "Could not enable %s: %s" %
+                    [self.name]
+            end
         end
     end
 end
-- 
1.6.0.6

